#!/bin/bash

alias wal="~/.local/bin/wal"

backend="wal"
backup="schemer2"

main() {
  echo "Setting up wallpaper..."
  echo $wall > $HOME/.cache/setbg/setbg.cache
  xwallpaper --zoom $wall
  echo "Generating pywal colorschemes..."
  wal -q --backend $backend -i $wall
  if [ $? != 0];then
     wal -q --backend $backup -i $wall
  fi
  pkill dunst
  exec dunst & 2>&1
  ~/.config/polybar/launch.sh
  ~/.spicetify/spicetify -qn apply
  $HOME/.scripts/wal-grub
  betterlockscreen -q -u $wall
  pywalfox update
}

help_message() {
  printf '%s\n' "
flags:
  -h  display help text
  -s         choose specific background using sxiv
             choose wallpaper by hitting m and q to quit
  -d         choose wallpaper using terminal
               example: setbg -d ./wallpaper.png
  -l         use last used wallpaper (found in cache file)
"

}

if [ "$#" == 0 ];then
  wall=$(find $HOME/.wallpapers -type f | shuf -n 1)
  main
fi

while getopts "hsld:" flag; do
   case $flag in
     h)
       help_message
     ;;
     s)
       if [ -z $(which sxiv) ];then
	printf "sxiv not found on your system!\n
	        arch: pacman -S sxiv\n
		debian: apt install sxiv"
	exit 1
       fi
       wall=$(sxiv -tpfo -z 200 $HOME/.wallpapers \
	       | tr ' ' '\n' \
	       | shuf -n 1)
       if [ -z "$wall" ];then
	 echo "no wallpapers selected!"; exit 1
       fi
       main
     ;;
     l)
       wall=$(cat $HOME/.cache/setbg/setbg.cache)
       if [ -z "$wall" ];then
	 printf '%s\n' "
	 wallpaper not found...
	 if there is a wallpaper in the cache please open a pr/issue"
       fi
       main
     ;;
     d)
       wall=$2
       if [ -z "$wall" ];then
	 echo "no wallpapers selected!"; exit 1
       fi
       main
     ;;
     \?)
       printf "invalid command!\n"
       help_message
       exit 1
     ;;
     :)
       echo "$OPTARG requires an argument"
       exit 1
     ;;
   esac
done
